# Test launcher for Jython 2.7 (GitHub action)

# The motivation for the test was the mis-handling of JVM arguments
# in jython.py, but we take this excuse to run a few tests on macOS,
# where we don't currently run the regression test in full.

name: launcher test 2.7

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:

  launcher-test-macos-jdk8:

    # Pin at 12 for Python 2 available
    runs-on: macos-12

    steps:
    - run: echo "Branch ${{ github.ref }} of repository ${{ github.repository }}."

    # Some tests require exactly-expected line endings
    - run: git config --global core.autocrlf input

    - uses: actions/checkout@v3

    # We have to install Python 2.7 explicitly
    # Based on https://github.com/LizardByte/setup-python-action specialised for MacOS
    - name: Set up Python 2
      shell: bash
      run: |
         # Use the default Python to install pip2.7
         python -V
         curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output get-pip.py
         python get-pip.py
         # Get a 2.7 virtual environment
         python -m pip install virtualenv
         venv="/tmp/python27/venv"
         python -m virtualenv ${venv}
         source ${venv}/bin/activate
         # See what we got
         python -V
         echo "${venv}/bin" >> $GITHUB_PATH
         python -V


    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Build with Ant
      run: ant -noinput -buildfile build.xml

    - name: Run Java tests with Ant
      run: ant javatest-ci

    - name: Show JVM arguments when launched by script
      run: dist/bin/jython -c 'from java.lang.management import ManagementFactory; print ManagementFactory.getRuntimeMXBean().getInputArguments()'

    - name: Show JVM arguments when launched by Python
      run: python dist/bin/jython.py -c 'from java.lang.management import ManagementFactory; print ManagementFactory.getRuntimeMXBean().getInputArguments()'

    - name: Regression tests for invocation of the interpreter with various command line arguments
      run: dist/bin/jython -m test.test_cmd_line

    - name: Regression tests for command line execution of scripts
      run: python dist/bin/jython.py -m test.test_cmd_line_script

